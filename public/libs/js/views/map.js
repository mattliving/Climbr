// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(["jquery", "underscore", "backbone", "collections/areas", "views/baseview", "goog!maps,3,other_params:[libraries=places&key=AIzaSyAjNafop09-jd2jkly8d05QaPcOa0WddX8&sensor=true]"], function($, _, Backbone, Areas, BaseView) {
    var MapView;
    MapView = (function(_super) {

      __extends(MapView, _super);

      function MapView() {
        return MapView.__super__.constructor.apply(this, arguments);
      }

      MapView.prototype.el = $("#map");

      MapView.prototype.events = {};

      MapView.prototype.initialize = function() {
        var _this = this;
        this.markers = [];
        Areas.bind("all", this.render, this);
        this.dispatcher.bind("render:routeMarkers", (function(locs) {
          return this.drawRouteMarkers(locs);
        }), this);
        return this.initMap(function(bounds) {
          Areas.fetch({
            data: {
              ll: bounds.getSouthWest().toUrlValue().split(","),
              ur: bounds.getNorthEast().toUrlValue().split(",")
            }
          });
          return _this.dispatcher.trigger("change:areas", Areas);
        });
      };

      MapView.prototype.render = function() {
        var area, latLng, marker, _i, _len, _ref, _results;
        this.markers.length = 0;
        _ref = Areas.models;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          area = _ref[_i];
          latLng = new google.maps.LatLng(area.get("loc")[0], area.get("loc")[1]);
          marker = new google.maps.Marker({
            position: latLng,
            draggable: false,
            map: this.map
          });
          _results.push(this.markers.push(marker));
        }
        return _results;
      };

      MapView.prototype.drawRouteMarkers = function(locs) {
        var avgX, avgY, center, latLng, loc, marker, _i, _len;
        avgX = avgY = 0;
        for (_i = 0, _len = locs.length; _i < _len; _i++) {
          loc = locs[_i];
          avgX += loc.x;
          avgY += loc.y;
          latLng = new google.maps.LatLng(loc.x, loc.y);
          marker = new google.maps.Marker({
            position: latLng,
            draggable: false,
            map: this.map
          });
        }
        center = new google.maps.LatLng(avgX / locs.length, avgY / locs.length);
        return this.map.setCenter(center);
      };

      MapView.prototype.toggleRouteMarkers = function() {};

      MapView.prototype.initMap = function(callback) {
        var geocoder, map, options,
          _this = this;
        options = {
          center: new google.maps.LatLng(-34.397, 150.644),
          minZoom: 4,
          zoom: 8,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        this.map = new google.maps.Map(this.el, options);
        map = this.map;
        geocoder = new google.maps.Geocoder();
        this.geoLocate(map);
        google.maps.event.addListener(map, "bounds_changed", function() {
          return callback(map.getBounds());
        });
        return this.dispatcher.bind("submit:search", function(address) {
          return _this.codeAddress(map, geocoder, address);
        });
      };

      MapView.prototype.initPlaces = function() {
        var ne, request, service, sw,
          _this = this;
        sw = new google.maps.LatLng(-90, -180);
        ne = new google.maps.LatLng(90, 180);
        request = {
          bounds: new google.maps.LatLngBounds(sw, ne),
          types: ["country"]
        };
        service = new google.maps.places.PlacesService(this.map);
        return service.search(request, function(places, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            return _this.dispatcher.trigger("init:places", places);
          }
        });
      };

      MapView.prototype.codeAddress = function(map, geocoder, address) {
        return geocoder.geocode({
          address: address
        }, function(results, status) {
          if (status === google.maps.GeocoderStatus.OK) {
            return map.panTo(results[0].geometry.location);
          } else {
            return alert("Geocode was not successful for the following reason: " + status);
          }
        });
      };

      MapView.prototype.geoLocate = function(map) {
        if (navigator.geolocation) {
          return navigator.geolocation.getCurrentPosition((function(position) {
            var pos;
            pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            return map.setCenter(pos);
          }), function() {
            return this.handleNoGeolocation(map, true);
          });
        } else {
          return this.handleNoGeolocation(map, false);
        }
      };

      MapView.prototype.handleNoGeolocation = function(map, errorFlag) {
        var content, infowindow, options;
        if (errorFlag) {
          content = "Error: The Geolocation service failed.";
        } else {
          content = "Error: Your browser doesn't support geolocation.";
        }
        options = {
          center: new google.maps.LatLng(60, 105),
          zoom: 6,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        infowindow = new google.maps.InfoWindow(options);
        return map.setCenter(options.center);
      };

      return MapView;

    })(BaseView);
    return MapView;
  });

}).call(this);
